{% load static %}

<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
      }
    }
</script>
{% load static %}

<style>
    body {
        margin: 0;
    }
</style>

<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
      }
    }
</script>
<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { FontLoader } from 'https://unpkg.com/three@0.150.1/examples/jsm/loaders/FontLoader.js';
    import { TextGeometry } from 'https://unpkg.com/three@0.150.1/examples/jsm/geometries/TextGeometry.js';

    
    let scene, camera, renderer

    // Parse the flower data passed from the Django template
    const flowerDataFromBackend = JSON.parse('{{ flower_data_json|escapejs }}');

    // Dynamic flower data generation based on backend data
    var flowerData = flowerDataFromBackend.map(function (flower) {
        return {
            id: flower.id,
            modelPath: flower.quality === 'good'
                ? "{% static 'models/flower_green.glb' %}"
                : "{% static 'models/flower_red.glb' %}"
        };
    });

    let totalFlowers = flowerData.length;
    let goodFlowers = flowerData.filter(flower =>
        flower.modelPath.includes('flower_green')
    ).length;

    flowerData = flowerDataFromBackend.map(function (flower) {
        return {
            id: flower.id,
            modelPath: flower.quality === 'good'
                ? "{% static 'models/flower_green.glb' %}"
                : "{% static 'models/flower_red.glb' %}"
        };
    }).sort(() => Math.random() - 0.5);

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 10, 7.5);
        scene.add(light);

        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const loader = new FontLoader();
        loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', function (loadedFont) {
            font = loadedFont;
            createTextObjects();
            createFlowers();
            animate();

            gameStartTime = Date.now();
            startGameTimer();
        });


    }

    function startGameTimer() {
        
    }

</script>